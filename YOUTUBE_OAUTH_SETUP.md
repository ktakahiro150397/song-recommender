# YouTube Music OAuth 設定ガイド

このガイドでは、YouTube Music APIのOAuth認証を設定し、自分のアカウントでプレイリストを作成できるようにする手順を説明します。

## 概要

プレイリストを自分のYouTube Musicアカウントに作成するには、YouTube Music APIの認証情報が必要です。このアプリでは、ユーザーごとに個別の認証情報を保存し、各ユーザーが自分のアカウントでプレイリストを作成できるようになっています。

## 必要な前提条件

- Googleアカウント（YouTube Musicを利用できるアカウント）
- Python 3.9以上
- ytmusicapi ライブラリ（このプロジェクトに含まれています）

## 設定手順

### 1. Google Cloud Consoleでプロジェクトを作成

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 新しいプロジェクトを作成（または既存のプロジェクトを使用）
3. プロジェクト名を入力（例: "song-recommender-oauth"）

### 2. YouTube Data API v3 を有効化

1. Google Cloud Console の左メニューから「APIとサービス」→「ライブラリ」を選択
2. "YouTube Data API v3" を検索
3. APIを選択して「有効にする」をクリック

### 3. OAuth 2.0 クライアントIDを作成

1. 左メニューから「APIとサービス」→「認証情報」を選択
2. 「認証情報を作成」→「OAuth クライアント ID」をクリック

#### OAuth同意画面の設定（初回のみ）

OAuth同意画面が未設定の場合、まず同意画面の設定が必要です：

1. 「OAuth同意画面」タブを選択
2. ユーザータイプ：
   - **外部**: 誰でもアクセス可能（推奨）
   - **内部**: Google Workspaceの組織内のみ
3. アプリ情報を入力：
   - アプリ名: "Song Recommender"（任意）
   - ユーザーサポートメール: あなたのメールアドレス
   - デベロッパーの連絡先: あなたのメールアドレス
4. スコープ: デフォルトのままでOK
5. テストユーザー（外部の場合）:
   - プレイリストを作成したいGoogleアカウントのメールアドレスを追加
   - 複数のユーザーを追加可能

#### クライアントIDの作成

1. 「認証情報」タブに戻る
2. 「認証情報を作成」→「OAuth クライアント ID」
3. アプリケーションの種類: **デスクトップアプリ**
4. 名前: "Song Recommender OAuth Client"（任意）
5. 「作成」をクリック
6. 表示されるクライアントIDとクライアントシークレットをメモ
7. 「JSONをダウンロード」をクリックして `client_secret.json` をダウンロード

### 4. OAuth認証ファイルを生成

ダウンロードした `client_secret.json` を使用して、OAuth認証ファイルを生成します。

#### 方法1: ytmusicapi コマンドを使用（推奨）

```bash
# リポジトリのルートディレクトリで実行
uv run ytmusicapi oauth

# または、Pythonがインストールされている場合
python -m ytmusicapi oauth
```

このコマンドを実行すると：

1. ブラウザが自動的に開きます
2. Googleアカウントでログイン
3. アプリへのアクセスを許可
4. `oauth.json` ファイルが生成されます

#### 方法2: Pythonスクリプトを使用

```python
from ytmusicapi import YTMusic

YTMusic.setup_oauth(filepath="oauth.json")
```

このスクリプトを実行すると、方法1と同じようにブラウザが開き、認証が完了します。

### 5. アプリに認証情報をアップロード

1. アプリにログイン
2. 「ユーザー設定」ページ（⚙️）にアクセス
3. 「YouTube Music 認証」セクションまでスクロール
4. 生成された `oauth.json` ファイルをアップロード
5. 「✅ YouTube Music 認証を設定しました」というメッセージが表示されれば成功

### 6. プレイリストを作成

認証が完了したら、プレイリスト作成機能を使用できます：

1. 「楽曲検索」ページで曲を検索
2. 連鎖検索を実行してプレイリストを作成
3. プレイリストがあなたのYouTube Musicアカウントに作成されます

## トラブルシューティング

### 「無効なOAuthファイルです」と表示される

- `oauth.json` ファイルが正しく生成されているか確認
- ファイルに `access_token`, `refresh_token`, `token_type` が含まれているか確認

### 認証エラーが発生する

- Google Cloud ConsoleでYouTube Data API v3が有効になっているか確認
- OAuth同意画面の設定で、使用するGoogleアカウントがテストユーザーに追加されているか確認（外部の場合）
- `client_secret.json` が正しいものか確認

### プレイリスト作成時にエラーが発生する

- YouTube Musicアカウントが有効か確認
- OAuth認証が期限切れの場合、再度認証ファイルを生成してアップロード

## セキュリティに関する注意事項

- `oauth.json` ファイルには、あなたのYouTube Musicアカウントにアクセスするための認証情報が含まれています
- このファイルは他人と共有しないでください
- アプリは認証情報を安全に保存しますが、不要になった場合は「認証を解除」ボタンで削除できます

## 認証情報の更新

認証情報は一定期間後に期限切れになる場合があります。その場合は：

1. ユーザー設定ページで「認証を解除」をクリック
2. 再度手順4から認証ファイルを生成
3. 新しい `oauth.json` をアップロード

## よくある質問

### Q: 複数のユーザーが同時にプレイリストを作成できますか？

A: はい。各ユーザーは自分の認証情報を設定することで、自分のYouTube Musicアカウントにプレイリストを作成できます。

### Q: 認証情報はどこに保存されますか？

A: 認証情報はアプリのデータベースにJSON形式で保存されます。他のユーザーはアクセスできません。

**セキュリティに関する注意:**
- 現在の実装では、OAuth情報は暗号化せずにデータベースに保存されます
- データベースへのアクセス権限を適切に管理してください
- 本番環境では、データベースの暗号化や列レベルの暗号化を検討することを推奨します

### Q: 認証を解除したらプレイリストも削除されますか？

A: いいえ。既に作成されたプレイリストはYouTube Musicアカウントに残ります。認証を解除しても削除されません。

### Q: OAuth同意画面の「公開ステータス」を本番環境にする必要がありますか？

A: 個人使用の場合は「テスト」のままで問題ありません。多くのユーザーが使用する場合は、Googleの審査を受けて本番環境にすることを検討してください。

## 参考リンク

- [ytmusicapi ドキュメント](https://ytmusicapi.readthedocs.io/)
- [Google Cloud Console](https://console.cloud.google.com/)
- [YouTube Data API v3](https://developers.google.com/youtube/v3)
